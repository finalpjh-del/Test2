<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ê²½ì°° ì–‘ì„± ê²Œì„</title>
<style>
  :root{--bg1:#ff9966;--bg2:#ff5e62;--ink:#10131a;--paper:#fff;--dark:#111}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(90deg,var(--bg1),var(--bg2));color:#fff;
       font-family:Arial,system-ui,sans-serif;text-align:center}
  h1{margin:12px 0 6px}
  button{border:0;padding:12px 16px;margin:6px;border-radius:14px;font-size:15px;cursor:pointer;
         transform:translateY(0);transition:transform .12s ease, filter .2s ease}
  button:hover{transform:translateY(-1px);filter:brightness(1.05)}
  button:disabled{opacity:.5;cursor:not-allowed}
  .ok{background:linear-gradient(90deg,#ff9966,#ff5e62);color:#fff;font-weight:800;box-shadow:0 6px 18px rgba(0,0,0,.25)}
  .ghost{opacity:.7}
  .bar{display:flex;align-items:center;justify-content:space-between;padding:8px 10px}
  .pill{background:#0b1020;color:#fff;border-radius:999px;padding:8px 12px;font-weight:700;text-decoration:none}
  .hud{margin:6px 0 2px}
  #pDice,#eDice{font-size:92px;display:inline-block}
  .shake{animation:shake .3s ease}
  @keyframes shake{
    0%{transform:translate(-2px,0) scale(1) rotate(0deg)}
    25%{transform:translate(8px,-6px) scale(1.3) rotate(20deg)}
    50%{transform:translate(-10px,4px) scale(0.9) rotate(-25deg)}
    75%{transform:translate(6px,-8px) scale(1.25) rotate(18deg)}
    100%{transform:translate(0,0) scale(1) rotate(0deg)}
  }
  .pop-enter{animation:pop .25s ease both}
  @keyframes pop{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}
  .flex{display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:wrap}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:14px;z-index:1000}
  .modal{width:min(92vw,640px);background:var(--paper);color:var(--ink);border-radius:18px;padding:20px;
         box-shadow:0 18px 50px rgba(0,0,0,.35)}
  .seg{display:inline-flex;border:1px solid rgba(0,0,0,.12);border-radius:12px;overflow:hidden}
  .seg button{background:#f3f6fb;color:#111;display:flex;align-items:center;gap:8px;padding:8px 12px}
  .seg button.selected{background:#111;color:#fff;font-weight:800}
  .titlechip{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:12px;color:#fff;
             background:linear-gradient(90deg,#ff9966,#ff5e62);font-weight:800;box-shadow:0 2px 10px rgba(255,120,90,.4)}
  #ending{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;color:#fff;z-index:1200}
  #ending .panel{width:min(92vw,780px);max-height:85vh;overflow:auto;-webkit-overflow-scrolling:touch;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.2);
                 border-radius:18px;padding:22px;text-align:left}
  #ending h2{margin:0 0 10px}
  #ending ul{list-style:none;padding:0;margin:8px 0 10px}
  #ending li{margin:6px 0}
  .sec{display:flex;align-items:center;gap:10px;margin:14px 0 8px}
  .sec .chip{padding:6px 12px;border-radius:999px;background:linear-gradient(90deg,#fff,#ffe4d6);color:#111;font-weight:800}
  .sec .line{height:1px;background:linear-gradient(90deg,rgba(255,255,255,.7),rgba(255,255,255,.1));flex:1}
  .cta{text-align:center;margin-top:10px}
  .small{font-size:13px;opacity:.9}
  input[type="text"]{padding:10px 12px;border-radius:12px;border:1px solid #ddd;width:100%;max-width:280px}
</style>
</head>
<body>
  <h1 class="pop-enter">ğŸ² ê²½ì°° ì–‘ì„± ğŸ²</h1>

  <div id="start" class="overlay" style="display:flex">
    <div class="modal pop-enter">
      <div class="titlechip">ğŸªª ì‹ ì› ì„ íƒ</div>
      <div style="height:8px"></div>
      <div>ì¡°ì§</div>
      <div class="seg" role="group">
        <button id="orgPolice">ğŸš“ ê²½ì°°</button>
        <button id="orgCoast">ğŸš¤ í•´ì–‘ê²½ì°°</button>
      </div>
      <div style="height:10px"></div>
      <div>ì„±ë³„</div>
      <div class="seg" role="group">
        <button id="genderM">ğŸ‘¨ ë‚¨ì</button>
        <button id="genderF">ğŸ‘© ì—¬ì</button>
      </div>
      <div style="height:10px"></div>
      <div>ì‹œì‘ ê³„ê¸‰</div>
      <div class="seg" role="group">
        <button id="rankStartA">ìˆœê²½</button>
        <button id="rankStartB">ê²½ìœ„</button>
      </div>
      <div style="height:10px"></div>
      <div class="flex">
        <label for="nm">ì´ë¦„</label>
        <input id="nm" type="text" placeholder="ë¹„ì›Œë‘ë©´ ê¸°ë³¸ ì´ë¦„ ì ìš©" />
      </div>
      <div class="flex" style="justify-content:flex-end">
        <button id="btnStart" class="ok">ì‹œì‘</button>
      </div>
    </div>
  </div>

  <div id="game" style="display:none">
    <div class="bar">
      <a class="pill" href="index.html">â¬…ï¸ ë©”ì¸</a>
      <span id="orgBadge" class="pill">ğŸš“ ê²½ì°°</span>
      <button id="btnResign" class="pill">ğŸ“ ì˜ì›ë©´ì§</button>
    </div>
    <div class="hud">
      <span id="emoji">ğŸ‘®</span>
      <span id="rank">ìˆœê²½</span>
      <span id="name">â€”</span>
      | â¤ï¸ <span id="hp">50</span>/<span id="maxhp">50</span>
      | ğŸ’° <span id="gold">0</span>
      | ğŸ’‰ êµ¬ê¸‰í•¨ <span id="bags">0</span>
      <!-- ê·¼ë¬´ê°œì›” í‘œì‹œëŠ” í”Œë ˆì´ í™”ë©´ì—ì„œ ì œê±° -->
    </div>
    <div>âš”ï¸ ì : <span id="enemyName"></span> (ì²´ë ¥: <span id="enemyHP"></span>)</div>
    <div style="margin-top:6px">
      <button id="btnRoll" class="ok">ğŸ² êµ´ë¦¬ê¸°</button>
      <button id="btnFire" class="ok">ğŸ”« ê²©ë°œ (-3ğŸ’°)</button>
    </div>
    <div class="flex" style="margin:6px 0">
      ë‚˜: <span id="pDice">ğŸ²</span> ì : <span id="eDice">ğŸ²</span>
    </div>
    <div id="msg" class="small">âš”ï¸ ì œì•• ì¤‘...</div>

    <div id="after" style="display:none">
      <div class="flex">
        <button id="btnRest">ğŸ›€ğŸ¼ ì”»ê³  ì¶œê·¼ (â¤ï¸5)</button>
        <button id="btnBuyBag">ğŸ’‰ êµ¬ê¸‰í•¨ (5ğŸ’°)</button>
        <button id="btnPromote">ğŸ–ï¸ ìŠ¹ì§„ë„ì „ (<span id="cost">10</span>ğŸ’°)</button>
        <button id="btnAmmo" class="ok">ğŸ”„ ë‹¤ìŒ í„´ íƒ„ì¢…: 9mm</button>
      </div>
      <div class="small">í„´ ì¢…ë£Œ ìƒíƒœ: ì—¬ê¸°ì„œ êµ¬ê¸‰í•¨ êµ¬ë§¤/ì‚¬ìš© ê°€ëŠ¥</div>
    </div>

    <div style="margin-top:6px">
      <button id="btnUseBag">ğŸ’‰â¤ï¸30</button>
    </div>
  </div>

  <div id="pop" class="overlay">
    <div class="modal pop-enter" style="max-height:85vh;overflow:auto;-webkit-overflow-scrolling:touch">
      <div id="popTitle" class="titlechip">ì•Œë¦¼</div>
      <ul id="popList" style="list-style:none; padding:0; margin:10px 0"></ul>
      <div class="flex" style="justify-content:flex-end">
        <button id="popOk" class="ok">í™•ì¸</button>
      </div>
    </div>
  </div>

  <div id="ending">
    <div class="panel pop-enter">
      <h2 id="endTitle">ì—”ë”©</h2>
      <ul id="endList"></ul>
      <div class="sec"><span class="chip">ìŠ¹ì§„ ì‹œì </span><span class="line"></span></div>
      <ul id="promoList"></ul>
      <div class="sec"><span class="chip">ìŠ¹ì§„/ê°•ë“± ì´ë ¥</span><span class="line"></span></div>
      <ul id="hist"></ul>
      <div class="sec"><span class="chip">ì œì•• ëª©ë¡</span><span class="line"></span></div>
      <ul id="kill"></ul>
      <div class="small">ì—”ë”© ë‚´ìš©ì´ ëª…ì˜ˆâ€¢ì¶”ëª¨ê´€ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
      <div class="cta">
        <a id="gotoGallery" href="honor_memorial.html" class="pill" style="text-decoration:none">ëª…ì˜ˆâ€¢ì¶”ëª¨ê´€ ì—´ê¸°</a>
      </div>
    </div>
  </div>

<script>
(()=>{
  const $ = id => document.getElementById(id);
  const RANKS = ["ì˜ê²½","ìˆœê²½","ê²½ì¥","ê²½ì‚¬","ê²½ìœ„","ê²½ê°","ê²½ì •","ì´ê²½","ê²½ë¬´ê´€","ì¹˜ì•ˆê°","ì¹˜ì•ˆì •ê°","ì¹˜ì•ˆì´ê°"];
  const DICE = ['âš€','âš','âš‚','âšƒ','âš„','âš…'];
  const ENEMIES = {1:["ğŸ§Ÿâ€â™‚ï¸ ì£¼ì·¨ì","ğŸ¦¹â€â™‚ï¸ ë³´ì´ìŠ¤í”¼ì‹±"],2:["ğŸ¤¹â€â™‚ï¸ ì‚¬ê¸°ê¾¼","ğŸ‘¨â€ğŸ’» ìŠ¤í† ì»¤"],3:["ğŸ§Œ ì¡°í­","ğŸ’Š ë§ˆì•½ì‚¬ë²”"],4:["ğŸ‘¤ ê°„ì²©","ğŸª– í…ŒëŸ¬ë¦¬ìŠ¤íŠ¸"],5:["ğŸ‘¨â€âœˆï¸ ë¶€íŒ¨í•œ ê²½ì°°","ğŸ—£ï¸ ë‚´ë€ ìš°ë‘ë¨¸ë¦¬"]};
  const MAX_LEVEL = 99;
  const MONTHS_PER_CLEAR = 4;

  const el = {
    start:$("start"), game:$("game"), pop:$("pop"), popTitle:$("popTitle"), popList:$("popList"), popOk:$("popOk"),
    btnStart:$("btnStart"), nm:$("nm"), orgPolice:$("orgPolice"), orgCoast:$("orgCoast"),
    genderM:$("genderM"), genderF:$("genderF"), rankStartA:$("rankStartA"), rankStartB:$("rankStartB"),
    orgBadge:$("orgBadge"), emoji:$("emoji"), rank:$("rank"), name:$("name"),
    hp:$("hp"), maxhp:$("maxhp"), gold:$("gold"), bags:$("bags"),
    enemyName:$("enemyName"), enemyHP:$("enemyHP"), btnRoll:$("btnRoll"), btnFire:$("btnFire"),
    pDice:$("pDice"), eDice:$("eDice"), msg:$("msg"),
    after:$("after"), btnRest:$("btnRest"), btnBuyBag:$("btnBuyBag"), btnPromote:$("btnPromote"), cost:$("cost"), btnUseBag:$("btnUseBag"),
    btnAmmo:$("btnAmmo"),
    ending:$("ending"), endTitle:$("endTitle"), endList:$("endList"), hist:$("hist"), kill:$("kill"), promoList:$("promoList"),
    btnResign:$("btnResign")
  };

  const state = {
    org:null, gender:null, name:"â€”",
    startRankIdx:1, rankIdx:1, entryRank:"ìˆœê²½",
    level:1, maxHP:50, hp:50, gold:0, bags:0,
    enemyHP:0, enemyLabel:"", cost:10,
    ended:false, startDate:new Date(),
    defeated:{}, changeLog:[],
    monthsAccum:0, finalGold:0,
    equalStreak:0, ammo:'22lr',
    demotionCount:0,
    lastRankChangeMonths:0,
    promotions:[] // {from,to,at:months}
  };

  const rint=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const emojiByGender=()=> state.gender==='F'?'ğŸ‘®â€â™€ï¸':(state.gender==='M'?'ğŸ‘®â€â™‚ï¸':'ğŸ‘®');
  const orgName=()=> state.org==='coast'?'í•´ì–‘ê²½ì°°':'ê²½ì°°';
  const enemyTier=lv=> lv<=10?1:lv<=25?2:lv<=45?3:lv<=70?4:5;
  const setBtns=on=>{ el.btnRoll.disabled=!on; el.btnFire.disabled=!on; el.btnUseBag.disabled=!on; };
  const updateFireLabel=()=>{ el.btnFire.textContent = (state.ammo==='9mm') ? "ğŸ”« ê²©ë°œ (-4ğŸ’°)" : "ğŸ”« ê²©ë°œ (-3ğŸ’°)"; };
  const fmtYM=(months)=>{ const y=Math.floor((months||0)/12), m=(months||0)%12; return m===0 ? `${String(y).padStart(2,'0')}ë…„` : `${String(y).padStart(2,'0')}ë…„ ${String(m).padStart(2,'0')}ê°œì›”`; };
  const monthsInRank=()=> state.monthsAccum - state.lastRankChangeMonths;

  const updateHUD=()=>{
    el.orgBadge.textContent=(state.org==='coast'?'ğŸš¤ í•´ì–‘ê²½ì°°':'ğŸš“ ê²½ì°°');
    el.emoji.textContent=emojiByGender();
    el.rank.textContent=RANKS[state.rankIdx];
    el.name.textContent=state.name;
    el.hp.textContent=state.hp;
    el.maxhp.textContent=state.maxHP;
    el.gold.textContent=state.gold;
    el.bags.textContent=state.bags;
    el.enemyName.textContent=state.enemyLabel;
    el.enemyHP.textContent=state.enemyHP;
    el.cost.textContent=state.cost;
    updateFireLabel();
  };
  const openPopup=(title,lines)=>{ el.popTitle.textContent=title; el.popList.innerHTML=(Array.isArray(lines)?lines:[lines]).map(x=>`<li>${x}</li>`).join(""); el.pop.style.display="flex"; setTimeout(()=>el.popOk.focus(),10); };
  const closePopup=()=> el.pop.style.display="none";
  el.popOk.onclick=closePopup; el.pop.onclick=e=>{ if(e.target===el.pop) closePopup(); };

  const pickEnemy=()=>{ const t=enemyTier(state.level); const list=ENEMIES[t]; const name=list[rint(0,list.length-1)]; state.enemyLabel=`Lv.${state.level} ${name}`; state.enemyHP=9+state.level*1; };
  const spawnEnemy=()=>{ el.after.style.display="none"; pickEnemy(); updateHUD(); setBtns(true); el.msg.textContent="âš”ï¸ ì œì•• ì¤‘..."; el.pDice.textContent="ğŸ²"; el.eDice.textContent="ğŸ²"; state.equalStreak=0; };

  function checkLongServiceBadge(){
    const m=state.monthsAccum;
    if(m>=360) return "30ë…„ ì¥ê¸°ê·¼ì†";
    if(m>=300) return "25ë…„ ì¥ê¸°ê·¼ì†";
    if(m>=240) return "20ë…„ ì¥ê¸°ê·¼ì†";
    return "";
  }

  function saveMemorial(endTitle, extraLines=[]) {
    try{
      const entry = {
        id: Date.now(),
        endTitle,
        name: state.name,
        org: orgName(),
        entryRank: state.entryRank,
        currentRank: RANKS[state.rankIdx],
        startDate: state.startDate,
        months: state.monthsAccum,
        level: state.level,
        defeated: state.defeated,
        changeLog: state.changeLog,
        finalGold: state.finalGold || state.gold || 0,
        longService: checkLongServiceBadge(),
        promotions: state.promotions
      };
      const arr = JSON.parse(localStorage.getItem("police_memorials")||"[]");
      arr.push(entry);
      localStorage.setItem("police_memorials", JSON.stringify(arr));
    }catch(e){ console.warn("saveMemorial failed", e); }
  }

  function addEndLines(base){
    const mAll=state.monthsAccum, y=Math.floor(mAll/12), m=mAll%12;
    const startStr = new Date(state.startDate).toLocaleDateString('ko-KR',{year:'numeric',month:'long',day:'numeric'});
    const lastGold = state.finalGold || state.gold || 0;
    base.push(`ì…ì‚¬ : ${startStr} ${orgName()} ${state.entryRank}`);
    base.push(`í˜„ì¬ ê³„ê¸‰ : ${RANKS[state.rankIdx]}`);
    base.push(`ê·¼ë¬´ê¸°ê°„ : ${fmtYM(state.monthsAccum)}`);
    base.push(`ë§ˆì§€ë§‰ ë³´ìœ  ê³¨ë“œ : ${lastGold}`);
  }

  function openEnding(title, extra=[]) {
    state.ended = true;
    const lines = [];
    if(title==="ìˆœì§"){ lines.push("ğŸª¦ ìˆœì§ìœ¼ë¡œ ì¸í•œ 1ê³„ê¸‰ íŠ¹ì§„"); }
    addEndLines(lines);
    el.endTitle.textContent = title;
    el.endList.innerHTML=lines.map(s=>`<li>${s}</li>`).join("");

    // promotions list
    if(state.promotions.length){
      el.promoList.innerHTML = state.promotions.map(p=>`<li>â€¢ ${p.from}â†’${p.to} : ${fmtYM(p.at)}ì°¨</li>`).join("");
    }else{
      el.promoList.innerHTML = `<li class="small">ê¸°ë¡ ì—†ìŒ</li>`;
    }

    el.hist.innerHTML = state.changeLog.length? state.changeLog.map(s=>`<li>â€¢ ${s}</li>`).join(""):`<li class="small">ê¸°ë¡ ì—†ìŒ</li>`;
    const ks=Object.keys(state.defeated);
    el.kill.innerHTML = ks.length? ks.map(k=>`<li>${k}: ${state.defeated[k]}ëª…</li>`).join(""):`<li class="small">ê¸°ë¡ ì—†ìŒ</li>`;
    saveMemorial(title);
    el.ending.style.display="flex";
  }

  function onDeath(){
    // ì œì•• ì¢…ë£Œ ì‹œì ì— 4ê°œì›” ëˆ„ì 
    state.monthsAccum += MONTHS_PER_CLEAR;
    // ìˆœì§ íŠ¹ì§„ (1ê³„ê¸‰)
    if(state.rankIdx < RANKS.length-1){ state.rankIdx += 1; }
    updateHUD();
    openEnding("ìˆœì§");
  }

  const logRankChange=(kind, prevIdx, nowIdx)=>{
    const R=RANKS, prev=R[prevIdx], now=R[nowIdx];
    const icon=kind.includes('ê·¼ì†')?'ğŸ†':(kind==='ìŠ¹ì§„'?'â¬†ï¸':'â¬‡ï¸');
    state.changeLog.push(`${icon} ${prev} â†’ ${now} ${kind}`);
  };

  const costForRank=(idx)=>{
    if(idx===0) return 7; // ì˜ê²½ -> ìˆœê²½ (ë³„ë„)
    // ìˆœê²½(1) ê¸°ì¤€ 10ì—ì„œ ë§¤ ë‹¨ê³„ 1.3ë°°
    const steps = idx-1; // number of multipliers already applied to reach idx->idx+1
    const v = Math.ceil(10 * (1.3 ** steps));
    return v;
  };

  function grantGold(){
    let earn=0;
    if(state.level<=10) earn=2; else if(state.level<=25) earn=4; else if(state.level<=45) earn=8; else if(state.level<=70) earn=16; else earn=32;
    if(state.rankIdx>0) earn+=state.rankIdx;
    if(state.level>=90) earn+=12; else if(state.level>=80) earn+=10; else if(state.level>=70) earn+=8;
    else if(state.level>=60) earn+=6; else if(state.level>=50) earn+=4; else if(state.level>=40) earn+=2; else if(state.level>=30) earn+=1;
    state.gold+=earn; updateHUD(); return earn;
  }
  const addDefeated=()=>{ const pure=state.enemyLabel.replace(/Lv\.[0-9]+\s+/,''); state.defeated[pure]=(state.defeated[pure]||0)+1; };

  function tryResign(){
    const wealthy = state.gold >= 500 || state.gold >= (state.cost*3);
    state.finalGold = state.gold;
    openEnding(wealthy ? "ì˜ì›ë©´ì§-ìì‚°ê°€" : "ì˜ì›ë©´ì§");
  }

  function checkAutoDismiss(){
    if(state.demotionCount >= 5){
      openEnding("íŒŒë©´");
      return true;
    }
    return false;
  }

  function afterClearMonthAndChecks(){
    // ëˆ„ì  4ê°œì›” (ì œì•• ì¢…ë£Œ ì‹œ)
    state.monthsAccum += MONTHS_PER_CLEAR;

    // ê·¼ì†ìŠ¹ì§„ ì²´í¬
    checkLongServicePromotion();

    // ì •ë…„í‡´ì§ ì²´í¬ (í˜„ ê³„ê¸‰ì—ì„œ ìŠ¹/ê°• ë¶ˆë°œë¡œ ì¼ì • ê¸°ê°„)
    checkRetirement();
  }

  function handleVictory(){
    addDefeated();
    let text="";
    if(state.enemyHP<=-15){
      if(state.rankIdx===0){ openEnding("íŒŒë©´"); return; }
      const prevIdx=state.rankIdx;
      state.rankIdx-=1;
      state.demotionCount += 1;
      state.cost = costForRank(state.rankIdx);
      state.maxHP=Math.max(10,state.maxHP-10);
      state.hp=Math.min(state.hp,state.maxHP);
      logRankChange("ê°•ë“±", prevIdx, state.rankIdx);
      updateHUD(); openPopup("â¬‡ï¸ ê°•ë“±",[`ê³„ê¸‰: ${RANKS[prevIdx]} â†’ ${RANKS[state.rankIdx]}`,`ìµœëŒ€ì²´ë ¥ -10`]);
      if(checkAutoDismiss()) return;
      text="ì  ì‚¬ë§, ê°•ë“±!";
    }else if(state.enemyHP<=-10){
      text="ê³¼ì‰ì§„ì•• ë³´ìƒì—†ìŒ";
    }else{
      const earned=grantGold(); text=`ì ì„ ì œì••í–ˆë‹¤! +${earned} ê³¨ë“œ íšë“!`;
    }

    afterClearMonthAndChecks();

    el.btnAmmo.textContent = state.ammo==='22lr' ? "ğŸ”„ ë‹¤ìŒ í„´ íƒ„ì¢…: 9mm" : "ğŸ”„ ë‹¤ìŒ í„´ íƒ„ì¢…: 22lr";
    el.msg.textContent=text; setBtns(false); el.after.style.display="block";
    if(state.level>=MAX_LEVEL){ openEnding("ì •ë…„í‡´ì§"); }
    else{ state.level+=1; }
  }

  const rollAnim=(p,e)=>{
    el.pDice.classList.add("shake"); el.eDice.classList.add("shake");
    setTimeout(()=>{
      el.pDice.classList.remove("shake"); el.eDice.classList.remove("shake");
      el.pDice.textContent=DICE[p-1]; el.eDice.textContent=DICE[e-1];
    },300);
  };

  function handleEqualStreak(p,e){
    if(p===e){
      state.equalStreak += 1;
      if(state.equalStreak>=2){
        const bonus = 10;
        state.gold += bonus;
        updateHUD();
        openPopup("ğŸ¯ ì—°ì† ë™ì‹œ ì ì¤‘!", `ì ê³¼ ê°™ì€ ì£¼ì‚¬ìœ„ ${state.equalStreak}íšŒ ì—°ì†! ë³´ë„ˆìŠ¤ +${bonus} ê³¨ë“œ`);
      }
    }else{
      state.equalStreak = 0;
    }
  }

  el.btnRoll.onclick=()=>{
    if(state.ended) return;
    setBtns(false);
    const p=rint(1,6), e=rint(1,6);
    rollAnim(p,e);
    setTimeout(()=>{
      state.enemyHP-=p; state.hp-=e; updateHUD(); handleEqualStreak(p,e);
      if(state.enemyHP<=0){ if(state.hp<=0){ onDeath(); return; } handleVictory(); return; }
      if(state.hp<=0){ onDeath(); return; }
      el.msg.textContent="âš”ï¸ ì œì•• ì¤‘...";
      setBtns(true);
    },300);
  };

  function fireStats(){
    return (state.ammo==='9mm') ? {cost:4, hit:0.45, min:35, max:45} : {cost:3, hit:0.50, min:20, max:25};
  }

  function enemyCounterThenResume(){
    const e=rint(1,6); el.pDice.textContent="â›”"; el.eDice.textContent=DICE[e-1];
    state.equalStreak=0;
    setTimeout(()=>{
      state.hp-=e; updateHUD(); if(state.hp<=0){ onDeath(); return; }
      el.msg.textContent="ì ì˜ ë°˜ê²©! ë‚´ ì£¼ì‚¬ìœ„ëŠ” í•œ í„´ ë¬´ë ¥í™”ë˜ì—ˆìŠµë‹ˆë‹¤.";
      setBtns(true);
    },1000);
  }

  el.btnFire.onclick=()=>{
    if(state.ended) return;
    const st = fireStats();
    if(state.gold<st.cost){ el.msg.textContent="ğŸ’° ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!"; return; }
    state.gold-=st.cost; updateHUD();
    const ok=Math.random()<st.hit;
    setBtns(false);
    if(ok){
      const dmg=rint(st.min,st.max);
      el.msg.textContent=`ğŸ¯ ì ì¤‘! (-${dmg} ë°ë¯¸ì§€)`;
      setTimeout(()=>{
        state.enemyHP-=dmg; updateHUD();
        if(state.enemyHP<=0){ if(state.hp<=0){ onDeath(); return; } handleVictory(); return; }
        enemyCounterThenResume();
      },1000);
    }else{
      el.msg.textContent="âŒ ì‹¤íŒ¨!";
      setTimeout(()=>{ enemyCounterThenResume(); },1000);
    }
  };

  el.btnAmmo.onclick=()=>{
    if(state.ammo==='22lr'){
      state.ammo='9mm';
      openPopup("ğŸ”„ íƒ„ì¢… ì „í™˜", "ë‹¤ìŒ í„´ë¶€í„° 9mmíƒ„ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.");
    }else{
      state.ammo='22lr';
      openPopup("ğŸ”„ íƒ„ì¢… ì „í™˜", "ë‹¤ìŒ í„´ë¶€í„° 22lríƒ„ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.");
    }
    updateFireLabel();
    el.btnAmmo.textContent = state.ammo==='22lr' ? "ğŸ”„ ë‹¤ìŒ í„´ íƒ„ì¢…: 9mm" : "ğŸ”„ ë‹¤ìŒ í„´ íƒ„ì¢…: 22lr";
  };

  el.btnRest.onclick=()=>{ if(state.ended) return; state.hp=Math.min(state.maxHP,state.hp+5); updateHUD(); spawnEnemy(); };
  el.btnBuyBag.onclick=()=>{ if(state.ended) return; if(state.gold>=5){ state.gold-=5; state.bags+=1; updateHUD(); } else{ el.msg.textContent="ğŸ’° ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!"; } };

  function tryPromoteRollRequirement(idx){
    // idx is current rank index, trying to go idx -> idx+1
    // ì˜ê²½(0): 3+, ìˆœê²½~ê²½ì¥(1~2): 4+, ê²½ì‚¬~ê²½ìœ„(3~4): 5+, ê²½ê°~ê²½ì •(5~6): 6+, ì´ê²½~ê²½ë¬´ê´€(7~8):7+, ì¹˜ì•ˆê°~ì¹˜ì•ˆì´ê°(9~10):8+
    if(idx===0) return 3;
    if(idx>=1 && idx<=2) return 4;
    if(idx>=3 && idx<=4) return 5;
    if(idx>=5 && idx<=6) return 6;
    if(idx>=7 && idx<=8) return 7;
    return 8;
  }

  function minMonthsForNext(idx){
    // current rank idx; minimum tenure in this rank to attempt promotion
    if(idx===0) return 36; // ì˜ê²½ -> ìˆœê²½ 3ë…„ ê·¼ì†ìŠ¹ì§„ ê¸°ì¤€ì„ ì¼ë°˜ë„ì „ì—ë„ ì ìš©
    if(idx>=1 && idx<=4) return 12; // ìˆœê²½~ê²½ìœ„
    if(idx>=5 && idx<=6) return 24; // ê²½ê°~ê²½ì •
    if(idx>=7 && idx<=9) return 12; // ì´ê²½~ì¹˜ì•ˆì •ê° (ì¹˜ì•ˆì´ê°ì€ ìµœìƒìœ„ë¼ ë„ì „ ì•ˆë¨)
    return 0;
  }

  function recordPromotion(prevIdx, nowIdx, kindLabel="ìŠ¹ì§„"){
    logRankChange(kindLabel, prevIdx, nowIdx);
    state.promotions.push({from:RANKS[prevIdx], to:RANKS[nowIdx], at: state.monthsAccum});
    state.lastRankChangeMonths = state.monthsAccum;
  }

  function doPromote(kindLabel="ìŠ¹ì§„"){
    const TOP=RANKS.length-1;
    if(state.rankIdx>=TOP){ openEnding("ëª…ì˜ˆí‡´ì§"); return; }
    const prevIdx=state.rankIdx; const prev=RANKS[prevIdx];
    state.rankIdx+=1;
    state.cost = costForRank(state.rankIdx);
    state.maxHP+=10; state.hp=Math.min(state.maxHP,state.hp+99);
    recordPromotion(prevIdx, state.rankIdx, kindLabel);
    updateHUD(); openPopup("ğŸ–ï¸ " + kindLabel + "!",[`ê³„ê¸‰: ${prev} â†’ ${RANKS[state.rankIdx]}`,`ìµœëŒ€ì²´ë ¥ +10`]);
  }

  el.btnPromote.onclick=()=>{
    if(state.ended) return;
    const TOP=RANKS.length-1; if(state.rankIdx>=TOP){ openEnding("ëª…ì˜ˆí‡´ì§"); return; }
    // min tenure check
    const needMonths = minMonthsForNext(state.rankIdx);
    if(monthsInRank() < needMonths){
      openPopup("â³ ìŠ¹ì§„ë„ì „ ë¶ˆê°€", `í˜„ ê³„ê¸‰ì—ì„œ ìµœì†Œ ${Math.floor(needMonths/12)}ë…„ ê²½ê³¼ í›„ ë„ì „ ê°€ëŠ¥ (í˜„ì¬: ${fmtYM(monthsInRank())})`);
      return;
    }
    const req = tryPromoteRollRequirement(state.rankIdx);
    if(state.gold < state.cost){ el.msg.textContent="ğŸ’° ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!"; return; }
    // ì†Œë¹„ í›„ ë„ì „
    state.gold -= state.cost; updateHUD();
    const a=rint(1,6), b=rint(1,6); el.pDice.textContent=DICE[a-1]; el.eDice.textContent=DICE[b-1];
    const sum=a+b;
    if(sum >= req){
      doPromote("ìŠ¹ì§„ë„ì „ ì„±ê³µ");
    }else{
      openPopup("âŒ ìŠ¹ì§„ë„ì „ ì‹¤íŒ¨", [`ìš”êµ¬í•©ê³„ â‰¥ ${req}`, `ë‚˜ì˜¨ í•©ê³„ = ${sum}`]);
    }
  };

  el.btnUseBag.onclick=()=>{
    if(state.ended) return;
    if(state.hp>=state.maxHP){ el.msg.textContent="â¤ï¸ ì²´ë ¥ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤."; return; }
    if(state.bags>0){
      state.bags-=1; state.hp=Math.min(state.maxHP,state.hp+30); updateHUD();
      if(el.after.style.display==="none"){
        // ì œì•• ì¤‘ ì‚¬ìš©: ë‚´ í„´ ë¬´íš¨, ì  ë°˜ê²©ë§Œ
        setBtns(false);
        enemyCounterThenResume();
      }else{
        // í„´ ì¢…ë£Œ ìƒíƒœì—ì„œ ì‚¬ìš©: ì¦‰ì‹œ íšŒë³µ, ë°˜ê²© ì—†ìŒ
        el.msg.textContent="ğŸ’‰ êµ¬ê¸‰í•¨ ì‚¬ìš©: â¤ï¸+30";
      }
    } else{ el.msg.textContent="ğŸ’‰ êµ¬ê¸‰í•¨ì´ ì—†ìŠµë‹ˆë‹¤!"; }
  };

  function applyStartRank(){
    state.rankIdx = state.startRankIdx;
    state.entryRank = RANKS[state.startRankIdx];
    state.lastRankChangeMonths = 0;
    state.promotions = [];
    if(state.startRankIdx===4){
      state.maxHP = 80; state.hp = 80; state.gold = 0;
      state.cost = costForRank(4);
    }else{
      state.rankIdx = 1; state.entryRank = RANKS[1];
      state.maxHP = 50; state.hp = 50; state.gold = 0;
      state.cost = costForRank(1);
    }
    state.ammo='22lr';
    updateFireLabel();
  }

  function resetSelections(){
    [el.orgPolice, el.orgCoast, el.genderM, el.genderF, el.rankStartA, el.rankStartB].forEach(b=>b.classList.remove('selected'));
    $("nm").value="";
  }

  function backToStart(){
    Object.assign(state, {
      org:null, gender:null, name:"â€”", startRankIdx:1, rankIdx:1, entryRank:"ìˆœê²½",
      level:1, maxHP:50, hp:50, gold:0, bags:0, enemyHP:0, enemyLabel:"", cost:10,
      ended:false, startDate:new Date(), defeated:{},
      changeLog:[], monthsAccum:0, finalGold:0, equalStreak:0, ammo:'22lr', demotionCount:0,
      lastRankChangeMonths:0, promotions:[]
    });
    el.start.style.display="flex"; el.game.style.display="none"; resetSelections(); setBtns(true); updateHUD();
  }

  el.btnStart.onclick=()=>{
    if(!state.org) state.org=Math.random()<0.5?'police':'coast';
    if(!state.gender) state.gender=Math.random()<0.5?'M':'F';
    const nm=($("nm").value||"").trim();
    state.name = nm ? nm : (state.org==='police' ? (state.gender==='F'?'í¬ìˆœ':'í¬ëŒ') : (state.gender==='F'?'í•´ëˆ„ë¦¬':'í•´ìš°ë¦¬'));
    state.startDate = new Date();
    applyStartRank();
    el.start.style.display="none"; el.game.style.display="block"; setBtns(true); spawnEnemy(); updateHUD();
  };

  // ê·¼ì†ìŠ¹ì§„ ë¡œì§
  function checkLongServicePromotion(){
    const idx = state.rankIdx;
    const m = monthsInRank();
    let need = null;
    if(idx===0) need = 36; // ì˜ê²½ -> ìˆœê²½
    else if(idx===1) need = 48; // ìˆœê²½ -> ê²½ì¥
    else if(idx===2) need = 60; // ê²½ì¥ -> ê²½ì‚¬
    else if(idx===3) need = 78; // ê²½ì‚¬ -> ê²½ìœ„ (6ë…„ 6ê°œì›”)
    else if(idx===4) need = 96; // ê²½ìœ„ -> ê²½ê°
    else need = null;

    if(need!=null && m >= need){
      doPromote("ê·¼ì†ìŠ¹ì§„");
    }
  }

  // ì •ë…„í‡´ì§ ë¡œì§ (í˜„ ê³„ê¸‰ì—ì„œ ì¼ì • ê¸°ê°„ ì •ì²´)
  function checkRetirement(){
    const idx=state.rankIdx;
    const m=monthsInRank();
    let limit=null;
    if(idx===6) limit=168;      // ê²½ì • 14ë…„
    else if(idx===7) limit=132; // ì´ê²½ 11ë…„
    else if(idx===8) limit=72;  // ê²½ë¬´ê´€ 6ë…„
    else if(idx===9) limit=48;  // ì¹˜ì•ˆê° 4ë…„
    if(limit!=null && m>=limit){
      openPopup("ğŸ–ï¸ ì •ë…„í‡´ì§", `í˜„ ê³„ê¸‰ ${RANKS[idx]}ì—ì„œ ${fmtYM(m)} ë™ì•ˆ ìŠ¹ì§„/ê°•ë“±ì´ ì—†ì–´ ì •ë…„í‡´ì§í•©ë‹ˆë‹¤.`);
      openEnding("ì •ë…„í‡´ì§");
    }
  }

  el.btnResign.onclick=()=>{ if(!state.ended) tryResign(); };

  backToStart();

})();
</script>
</body>
</html>
